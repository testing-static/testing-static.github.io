

<!DOCTYPE html>
<html class="writer-html5" lang="id" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>surat.views &mdash; Dokumentasi MyUMS 2019</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/translations.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Indeks" href="../../genindex.html" />
    <link rel="search" title="Pencarian" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MyUMS
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules/pid/index.html">1. PID</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/insentif/index.html">2. INSENTIF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/profil/index.html">3. PROFIL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/monitoring/index.html">4. MONITORING</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/sipas/index.html">5. SIPAS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/about.html">Tentang MyUMS</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MyUMS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Kode modul</a> &raquo;</li>
        
      <li>surat.views</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Kode sumber untuk surat.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="c1"># from django.contrib.auth import login, authenticate</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.mixins</span> <span class="kn">import</span> <span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">AccessMixin</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="kn">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="kn">import</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseForbidden</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>

<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">xlsxwriter</span>

<span class="kn">from</span> <span class="nn">.helper</span> <span class="kn">import</span> <span class="n">get_tendik</span><span class="p">,</span> <span class="n">get_dosen</span><span class="p">,</span> <span class="n">get_jabatan</span>  <span class="c1"># , generate_token_by_user</span>
<span class="c1"># from .signal import in_rektorat_group</span>

<span class="c1"># ================================================ Custom Auth ==========================================================================================</span>
<span class="c1"># def in_rektorat_group(user):</span>
<span class="c1">#     if user:</span>
<span class="c1">#         return user.groups.filter(name=&#39;REKTORAT&#39;).exists()</span>
<span class="c1">#     return False</span>


<div class="viewcode-block" id="in_testing_group"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.in_testing_group">[docs]</a><span class="k">def</span> <span class="nf">in_testing_group</span><span class="p">(</span><span class="n">user</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;TESTING&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="PejabatOrDelegasiOrAdminRektoratRequiredMixin"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.PejabatOrDelegasiOrAdminRektoratRequiredMixin">[docs]</a><span class="k">class</span> <span class="nc">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">(</span><span class="n">AccessMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class Mixin untuk memfilter hak akses. Hanya pejabat atau delegasi atau admin rektorat yang dapat mengakses </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    
<div class="viewcode-block" id="PejabatOrDelegasiOrAdminRektoratRequiredMixin.dispatch"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.PejabatOrDelegasiOrAdminRektoratRequiredMixin.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>        
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;sipas_home&quot;</span><span class="p">)</span>
        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>

        <span class="n">api_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/cek_kode_jabatan/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>        
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>          
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="LembagaRequiredMixin"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.LembagaRequiredMixin">[docs]</a><span class="k">class</span> <span class="nc">LembagaRequiredMixin</span><span class="p">(</span><span class="n">AccessMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class Mixin untuk memfilter hak akses. Hanya lembaga yang dapat mengakses </span>
<span class="sd">    &quot;&quot;&quot;</span> 

<div class="viewcode-block" id="LembagaRequiredMixin.dispatch"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.LembagaRequiredMixin.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>        
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;sipas_home&quot;</span><span class="p">)</span>
        
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>

        <span class="n">api_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/cek_kode_lembaga/</span><span class="si">{</span><span class="n">kode_lembaga</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>        
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>          
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="pejabat_or_delegasi_or_admin_rektorat"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.pejabat_or_delegasi_or_admin_rektorat">[docs]</a><span class="k">def</span> <span class="nf">pejabat_or_delegasi_or_admin_rektorat</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Decorator untuk memfilter hak akses. Hanya pejabat atau delegasi atau admin rektorat yang dapat mengakses </span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;sipas_home&quot;</span><span class="p">)</span>

        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>

        <span class="n">api_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/cek_kode_jabatan/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">api_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>        
            <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>                                
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">wrap</span></div>


<span class="c1"># ================================================ Choices ==========================================================================================</span>
<span class="n">SIFAT_SURAT</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;SP&#39;</span><span class="p">,</span> <span class="s1">&#39;Sangat Penting&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Penting&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;Biasa&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">STATUS_SURAT_MASUK</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;diterima&#39;</span><span class="p">,</span> <span class="s1">&#39;diterima&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;proses&#39;</span><span class="p">,</span> <span class="s1">&#39;proses&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;selesai&#39;</span><span class="p">,</span> <span class="s1">&#39;selesai&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">KODE_TUJUAN</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;A.1&#39;</span><span class="p">,</span> <span class="s1">&#39;A.1 [KE DALAM] Rektor / PR. I, II, III&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;A.2&#39;</span><span class="p">,</span> <span class="s1">&#39;A.2 [KE DALAM] Pimp.Lembaga / Dekan / PD.I, II, III&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;A.3&#39;</span><span class="p">,</span> <span class="s1">&#39;A.3 [KE DALAM] Dosen&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;A.4&#39;</span><span class="p">,</span> <span class="s1">&#39;A.4 [KE DALAM] Mahasiswa&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;A.5&#39;</span><span class="p">,</span> <span class="s1">&#39;A.5 [KE DALAM] Karyawan&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;A.6&#39;</span><span class="p">,</span> <span class="s1">&#39;A.6 [KE DALAM] Lain-lain&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;B.1&#39;</span><span class="p">,</span> <span class="s1">&#39;B.1 [MUHAMMADIYYAH] Tingkat Pusat&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;B.2&#39;</span><span class="p">,</span> <span class="s1">&#39;B.2 [MUHAMMADIYYAH] Tingkat Wilayah&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;B.3&#39;</span><span class="p">,</span> <span class="s1">&#39;B.3 [MUHAMMADIYYAH] Tingkat Daerah&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;B.3&#39;</span><span class="p">,</span> <span class="s1">&#39;B.4 [MUHAMMADIYYAH] Tingkat Cabang&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;B.3&#39;</span><span class="p">,</span> <span class="s1">&#39;B.5 [MUHAMMADIYYAH] Tingkat Ranting&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;B.4&#39;</span><span class="p">,</span> <span class="s1">&#39;B.6 [MUHAMMADIYYAH] Ortom-ortom, dll&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;C.1&#39;</span><span class="p">,</span> <span class="s1">&#39;C.1 [PEMERINTAH] Kopertis&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;C.2&#39;</span><span class="p">,</span> <span class="s1">&#39;C.2 [PEMERINTAH] Depdikbud / Depag &#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;C.3&#39;</span><span class="p">,</span> <span class="s1">&#39;C.3 [PEMERINTAH] PTN / IAIN&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;C.4&#39;</span><span class="p">,</span> <span class="s1">&#39;C.4 [PEMERINTAH] Dep Kes Kanwil / Dinas Kesehatan&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;C.5&#39;</span><span class="p">,</span> <span class="s1">&#39;C.5 [PEMERINTAH] Pemerintah Pusat&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;C.6&#39;</span><span class="p">,</span> <span class="s1">&#39;C.6 [PEMERINTAH] Pemda tingkat I&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;C.7&#39;</span><span class="p">,</span> <span class="s1">&#39;C.7 [PEMERINTAH] Pemda tingkat II&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;C.8&#39;</span><span class="p">,</span> <span class="s1">&#39;C.8 [PEMERINTAH] Instansi Pemerintah Lainnya&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;D.1&#39;</span><span class="p">,</span> <span class="s1">&#39;D.1 [Swasta] PTS / Akademi Swasta / Sekolah Tinggi&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;D.2&#39;</span><span class="p">,</span> <span class="s1">&#39;D.2 [Swasta] Instansi Swasta&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;D.3&#39;</span><span class="p">,</span> <span class="s1">&#39;D.3 [Swasta] Perorangan, dll&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">KODE_URUSAN</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;I - Kemahasiswaan&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;II - Pendidikan&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;III - Penelitian&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;IV - Personalia&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;V - Humas / Perpustakaan&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VI - Perlengkapan&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;VII&#39;</span><span class="p">,</span> <span class="s1">&#39;VII - Keuangan&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;VIII&#39;</span><span class="p">,</span> <span class="s1">&#39;VIII - Lain-lain&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">BULAN</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;I - Januari&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;II&#39;</span><span class="p">,</span> <span class="s1">&#39;II - Februari&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;III&#39;</span><span class="p">,</span> <span class="s1">&#39;III - Maret&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;IV&#39;</span><span class="p">,</span> <span class="s1">&#39;IV - April&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;V - Mei&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;VI&#39;</span><span class="p">,</span> <span class="s1">&#39;VI - Juni&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;VII&#39;</span><span class="p">,</span> <span class="s1">&#39;VII - Juli&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;VIII&#39;</span><span class="p">,</span> <span class="s1">&#39;VIII - Agustus&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;IX&#39;</span><span class="p">,</span> <span class="s1">&#39;IX - September&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">,</span> <span class="s1">&#39;X - Oktober&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;XI&#39;</span><span class="p">,</span> <span class="s1">&#39;XI - November&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;XII&#39;</span><span class="p">,</span> <span class="s1">&#39;XII - Desember&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">JENIS_SURAT</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Surat Keputusan&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;Surat Tugas&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;Lain-Lain&#39;</span><span class="p">),</span>
<span class="p">]</span>

<span class="c1"># ================================================ Others ==========================================================================================</span>
<div class="viewcode-block" id="sipas_home"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.sipas_home">[docs]</a><span class="nd">@login_required</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">sipas_home</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>    
    <span class="c1"># request.session[&#39;kode_jabatan&#39;] = &#39;ADMIN_REKTORAT&#39;</span>
    <span class="c1"># request.session[&#39;kode_lembaga&#39;] = &#39;ADMIN_REKTORAT&#39;    </span>
    <span class="sd">&quot;&quot;&quot; Function View untuk masuk halaman SIPAS dan mendapatkan token</span>

<span class="sd">    Alur:  </span>

<span class="sd">        | 1. ambil token dari server SIPAS</span>
<span class="sd">        | 2. cek apakah punya token, jika ya, token digunakan dan selesai</span>
<span class="sd">        | 3. jika belum memiliki token (berarti belum punya user):</span>
<span class="sd">        |    a. buat user di backend SIPAS</span>
<span class="sd">        |    b. ambil token dan gunakan</span>
<span class="sd">        | 4. cek apakah punya jabatan. Jika punya, tampilkan menu Surat keluar, Surat Keputusan, Arsip</span>
<span class="sd">        | 5. Tampilkan menu Surat masuk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">konteks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># request.session[&#39;url_backend&#39;] = settings.SIPAS_BACKEND_URL</span>
    <span class="n">get_token_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/token/&quot;</span>  <span class="c1"># 1. ambil token</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">get_token_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">})</span>  <span class="c1"># mengambil token jika sudah ada</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>  <span class="c1"># 2. jika punya token, token digunakan</span>
            <span class="c1"># print(&#39;sipas menu:&#39;, request.user.username, &#39;sudah punya token&#39;)</span>
        <span class="k">elif</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>  <span class="c1"># 3. belum memiliki token dan user di backend</span>
            <span class="n">create_user_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/buatuser/&quot;</span>  <span class="c1"># 3.a. buat user</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">create_user_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">})</span>
            <span class="c1"># print(&#39;sipas menu 2:&#39;, r, r.content)</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>  <span class="c1"># 3.b. jika berhasil buat user, ambil token</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Gagal mengakses token untuk Anda. Sistem mungkin tidak bekerja.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Gagal mengakses token. Sistem mungkin tidak bekerja&#39;</span><span class="p">)</span>

        <span class="c1"># akademik = &#39;sipas&#39;  # ini berarti menu SIPAS sedang aktif</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;sipas_aktif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;transport_mengajar_aktif&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">in_testing_group</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">):</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;TESTING&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Sistem Arsip merespon terlalu lama.&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Gagal menghubungi sistem Arsip, SIPAS belum bisa berjalan&#39;</span><span class="p">)</span>

    <span class="c1"># untuk mendapat apakah punya jabatan untuk pertama kali login</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">url_ws</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIHRD_URL</span><span class="si">}</span><span class="s2">umar/v2/jabatan/</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># 4. cek apakah punya jabatan</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_ws</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SIHRD_WS_UNAME</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIHRD_WS_PWD</span><span class="p">))</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">dt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dt</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># untuk default</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Biro Rektorat&#39;</span><span class="p">:</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;nama_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Admin Rektorat&#39;</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;is_rektorat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">]</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;nama_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;nama&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;is_pejabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Sistem SiHRD merespon terlalu lama.&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Gagal menghubungi SiHRD&#39;</span><span class="p">)</span>

    
    <span class="c1"># daftar jabatan dari jabatan, delegasi, dan group</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;daftar_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>            
    
    <span class="n">list_menjabat</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_menjabat/&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">list_menjabat</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>                    
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;list_jabatan&#39;</span><span class="p">]</span>        
        <span class="k">if</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>                
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;daftar_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>                
        
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/home_sipas.html&#39;</span><span class="p">,</span> <span class="n">konteks</span><span class="p">)</span></div>


<div class="viewcode-block" id="ubah_session_jabatan"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.ubah_session_jabatan">[docs]</a><span class="nd">@login_required</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">ubah_session_jabatan</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function View untuk mengubah session jabatan pengguna dan memberitahu sistem apakah session adalah pejabat atau admin rektorat</span>

<span class="sd">    Alur:  </span>

<span class="sd">        | 1. frontend memanggil api sipas backend untuk melihat deskripsi jabatan dengan parameter kode jabatan</span>
<span class="sd">        | 2. api meresponse dengan memberi umpan balik kode jabatan, kode lembaga, dan nama jabatan </span>

<span class="sd">    Return:</span>

<span class="sd">        | kode jabatan, kode lembaga, dan nama jabatan</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="n">deskripsi_jabatan</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/deskripsi_jabatan/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>    
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">deskripsi_jabatan</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>                    
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>        
        <span class="k">if</span> <span class="n">dt</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>                            
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">]</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;nama_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nama_jabatan&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;is_pejabat&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;is_pejabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_pejabat&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;is_rektorat&#39;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;is_rektorat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;is_rektorat&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;sipas_home&#39;</span><span class="p">)</span>     </div>


<span class="c1"># buat dapetin jumlah yang belum dibaca</span>
<div class="viewcode-block" id="update_kotak_masuk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.update_kotak_masuk">[docs]</a><span class="k">def</span> <span class="nf">update_kotak_masuk</span><span class="p">(</span><span class="n">view_func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function untuk mendapatkan jumlah surat masuk yang belum dibaca pengguna</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;sipas_home&#39;</span><span class="p">)</span>     
        
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>                                    
        <span class="n">url_belum_dibaca</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/belum_dibaca/&quot;</span>
        <span class="n">r_url_belum_dibaca</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_belum_dibaca</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r_url_belum_dibaca</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">r_url_belum_dibaca</span> <span class="o">=</span> <span class="n">r_url_belum_dibaca</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Gagal mengakses jumlah surat masuk dikarenakan token belum terbuat. Silakan memuat ulang/refresh halaman ini untuk mendapatkan token&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;sipas_home&#39;</span><span class="p">)</span>     
        
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;jml_blm_baca&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_url_belum_dibaca</span><span class="p">[</span><span class="s1">&#39;surat_masuk_belum_dibaca&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">update</span></div>


<div class="viewcode-block" id="list_jabatan"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.list_jabatan">[docs]</a><span class="k">def</span> <span class="nf">list_jabatan</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function untuk mendapatkan daftar semua jabatan</span>

<span class="sd">    Return:</span>

<span class="sd">        | daftar kode jabatan dan dan nama jabatan</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/jabatan_list&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span></div>


<span class="c1"># untuk update JABATANSIHRD, tapi disini belum terpakai</span>
<div class="viewcode-block" id="UserDashboard"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UserDashboard">[docs]</a><span class="k">class</span> <span class="nc">UserDashboard</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

    <span class="c1"># def get_context_data(self, **kwargs):</span>
    <span class="c1">#     context = super(UserDashboard, self).get_context_data(**kwargs)</span>
    <span class="c1">#     return context</span>
    <span class="c1">#</span>
<div class="viewcode-block" id="UserDashboard.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UserDashboard.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">tgl</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">today</span><span class="p">()</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">day</span>
        <span class="c1"># print(tgl)</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tgl</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">tgl</span> <span class="o">==</span> <span class="mi">25</span><span class="p">:</span>
            <span class="n">update_pejabat_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/update_pejabat_hrd/&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">update_pejabat_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>            
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/dashboard.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;dashboard&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></div></div>


<span class="c1"># ================================================ Surat Masuk ==========================================================================================</span>
<div class="viewcode-block" id="SuratMasukTahun"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratMasukTahun">[docs]</a><span class="k">class</span> <span class="nc">SuratMasukTahun</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class View untuk mendapatkan daftar surat masuk berdasarkan tahun.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
    
    <span class="c1">#method decorator buat ngedapetin jumlah yang belum dibaca</span>
<div class="viewcode-block" id="SuratMasukTahun.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratMasukTahun.get">[docs]</a>    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">update_kotak_masuk</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">tahun</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot; Function View untuk mendapatkan daftar surat masuk berdasarkan tahun.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        

        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>
        
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>

        <span class="c1"># dipake buat dia nampilin tombol pembuatan surat masuk, jika ada jabatan/delegasi berdasarkan session kode_jabatan, tombol muncul</span>
        <span class="n">struktural_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/cek_kode_jabatan/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">struktural_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>                
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;is_jabatan_or_delegasi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;is_jabatan_or_delegasi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>        

        <span class="c1"># dapatkan tahun untuk di list</span>
        <span class="n">struktural_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/list_tahun&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">struktural_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># dapatkan surat masuk        </span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tahun</span>
        <span class="n">suratmasuk_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/tahun/</span><span class="si">{</span><span class="n">tahun</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suratmasuk_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonresponse</span>                        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/suratmasuk.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratmasuk&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="DetailSuratMasuk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DetailSuratMasuk">[docs]</a><span class="k">class</span> <span class="nc">DetailSuratMasuk</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class View untuk mendapatkan detail surat masuk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="DetailSuratMasuk.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DetailSuratMasuk.get">[docs]</a>    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">update_kotak_masuk</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>                  
        <span class="sd">&quot;&quot;&quot; Function View untuk melihat detail surat masuk dan menampilkan disposisi</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>

        <span class="c1"># menampilkan surat masuk berdasarkan id nya</span>
        <span class="n">detailsuratmasuk_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/</span><span class="si">{</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">detailsuratmasuk_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat masuk tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># untuk isian disposisi dikirimnya ke siapa aja</span>
        <span class="n">list_tendik</span> <span class="o">=</span> <span class="n">get_tendik</span><span class="p">()</span>
        <span class="n">list_dosen</span> <span class="o">=</span> <span class="n">get_dosen</span><span class="p">()</span>
        <span class="n">list_jabatan</span> <span class="o">=</span> <span class="n">get_jabatan</span><span class="p">()</span>
        <span class="n">list_pegawai</span> <span class="o">=</span> <span class="n">list_tendik</span><span class="o">+</span><span class="n">list_dosen</span><span class="o">+</span><span class="n">list_jabatan</span>

        <span class="n">url_backend</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/detailsuratmasuk.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratmasuk&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">,</span><span class="s1">&#39;konteks&#39;</span><span class="p">:</span><span class="n">list_pegawai</span><span class="p">,</span><span class="s1">&#39;url_backend&#39;</span><span class="p">:</span><span class="n">url_backend</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="BuatSuratMasuk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSuratMasuk">[docs]</a><span class="k">class</span> <span class="nc">BuatSuratMasuk</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class View untuk membuat surat masuk</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
        
<div class="viewcode-block" id="BuatSuratMasuk.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSuratMasuk.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function View untuk menampilkan tampilan buat surat masuk</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>                        

        <span class="c1"># untuk isian</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;sifat_surat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIFAT_SURAT</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;status_surat_masuk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STATUS_SURAT_MASUK</span>

        <span class="c1"># untuk dilempar ke uniid penerima jika bukan admin rektorat</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_jabatan</span>
        <span class="c1"># untuk daftar yang berhak ttd  khusus rektorat               </span>
        <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>            
            <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_jabatan_unit/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_jabatan_ttd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_jabatan&#39;</span><span class="p">]</span>        

        <span class="c1"># generate nomor surat masuk</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/buat_surat_masuk.html&#39;</span><span class="p">,</span> <span class="n">konteks</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuatSuratMasuk.post"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSuratMasuk.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function View untuk menyimpan data surat masuk </span>
<span class="sd">        &quot;&quot;&quot;</span> 

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        

        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># untuk auth</span>
            <span class="s1">&#39;kode_jabatan&#39;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">),</span>            
            <span class="c1"># untuk isian di surat keluar</span>
            <span class="s1">&#39;file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]),</span>
            <span class="s1">&#39;sifat_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sifat_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;asal_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;asal_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;no_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_surat&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;alamat_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alamat_surat&#39;</span><span class="p">)),</span>                        
            <span class="s1">&#39;tgl_acara&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_acara&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;perihal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perihal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;ringkasan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;tgl_pada_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_pada_surat&#39;</span><span class="p">)),</span>                        
            <span class="s1">&#39;jenis_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="s2">&quot;5&quot;</span><span class="p">),</span>
            <span class="s1">&#39;nama_file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="c1"># &#39;no_extend&#39;: (None,request.POST.get(&#39;jenis_surat&#39;)),</span>
            <span class="c1"># &#39;nomor&#39;: (None,request.POST.get(&#39;nomor&#39;)),            </span>
            <span class="s1">&#39;uniid_penerima&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uniid_penerima&#39;</span><span class="p">))</span>
        <span class="p">}</span>        
        <span class="n">suratmasuk_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">suratmasuk_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span><span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        
        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat masuk tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;BuatSuratMasuk&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HapusSuratMasuk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.HapusSuratMasuk">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">HapusSuratMasuk</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function View untuk menghapus surat masuk</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>

    <span class="n">detailsuratmasuk_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">detailsuratmasuk_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat masuk tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>            
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="edit_surat_masuk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.edit_surat_masuk">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">edit_surat_masuk</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function View untuk mengubah surat masuk</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>

    <span class="n">detailsuratmasuk_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">detailsuratmasuk_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
    <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Http404</span><span class="p">(</span><span class="s2">&quot;Url does not exist&quot;</span><span class="p">)</span>    
    <span class="k">if</span> <span class="n">jsonresponse</span><span class="p">[</span><span class="s1">&#39;is_surat_eksternal&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseForbidden</span><span class="p">()</span>

    <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;status_surat_masuk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">STATUS_SURAT_MASUK</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;sifat_surat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIFAT_SURAT</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>

    <span class="c1"># untuk dilempar ke uniid penerima jika bukan admin rektorat</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_jabatan</span>
    <span class="c1"># untuk daftar yang berhak ttd  khusus rektorat               </span>
    <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>            
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_jabatan_unit/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_jabatan_ttd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_jabatan&#39;</span><span class="p">]</span>        
    
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># untuk auth</span>
            <span class="s1">&#39;kode_jabatan&#39;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">),</span>            
            <span class="c1"># untuk isi file</span>
            <span class="s1">&#39;sifat_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sifat_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;asal_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;asal_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;alamat_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alamat_surat&#39;</span><span class="p">)),</span>     
            <span class="s1">&#39;tgl_acara&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_acara&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;perihal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perihal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;ringkasan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;status&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;tgl_pada_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_pada_surat&#39;</span><span class="p">)),</span>                        
            <span class="s1">&#39;uniid_penerima&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uniid_penerima&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;no_surat&#39;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;is_surat_eksternal&#39;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>            
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">])</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;file_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
        <span class="n">suratmasuk_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">suratmasuk_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span><span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat masuk tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>            

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/edit_surat_masuk.html&#39;</span><span class="p">,</span><span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">,</span><span class="s1">&#39;konteks&#39;</span><span class="p">:</span><span class="n">konteks</span><span class="p">}</span> <span class="p">)</span></div>


<div class="viewcode-block" id="cetak_surat_masuk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.cetak_surat_masuk">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">cetak_surat_masuk</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>        
    <span class="sd">&quot;&quot;&quot; Function untuk memcetak surat masuk</span>

<span class="sd">    Return:</span>
<span class="sd">        | file .xlsx berisi daftar surat masuk berdasarkan tanggal surat</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>
            
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;kode_jabatan&#39;</span> <span class="p">:</span> <span class="n">kode_jabatan</span><span class="p">,</span>
        <span class="s1">&#39;tgl_mulai&#39;</span> <span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;tgl_mulai&#39;</span><span class="p">],</span>
        <span class="s1">&#39;tgl_akhir&#39;</span> <span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">[</span><span class="s1">&#39;tgl_akhir&#39;</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/cetak_surat&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>    
    
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>        

        <span class="n">output</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
        <span class="n">workbook</span> <span class="o">=</span> <span class="n">xlsxwriter</span><span class="o">.</span><span class="n">Workbook</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="n">worksheet</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">.</span><span class="n">add_worksheet</span><span class="p">()</span>

        <span class="c1"># Get some data to write to the spreadsheet.</span>
        <span class="n">data_mentah</span> <span class="o">=</span> <span class="n">jsonresponse</span>        
        <span class="n">data_diolah</span><span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;Tanggal Surat&quot;</span><span class="p">,</span> <span class="s2">&quot;Nomor Surat&quot;</span><span class="p">,</span> <span class="s2">&quot;Dari&quot;</span><span class="p">,</span> <span class="s2">&quot;Kepada&quot;</span><span class="p">,</span> <span class="s2">&quot;Sifat Surat&quot;</span><span class="p">,</span> <span class="s2">&quot;Perihal&quot;</span><span class="p">,</span> <span class="s2">&quot;Ringkasan Surat&quot;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data_mentah</span><span class="p">:</span>
            <span class="n">temp_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;tanggal_surat_parsed&#39;</span><span class="p">])</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;no_surat&#39;</span><span class="p">])</span>            
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;asal_nama_lembaga&#39;</span><span class="p">])</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;kepada_nama_lembaga_atau_karyawan&#39;</span><span class="p">])</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;sifat_surat&#39;</span><span class="p">])</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;perihal&#39;</span><span class="p">])</span>
            <span class="n">temp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">])</span>        
            <span class="n">data_diolah</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">temp_list</span><span class="p">)</span>
        <span class="c1"># # Write some test data.</span>
        <span class="k">for</span> <span class="n">row_num</span><span class="p">,</span> <span class="n">columns</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_diolah</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col_num</span><span class="p">,</span> <span class="n">cell_data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">columns</span><span class="p">):</span>                
                <span class="n">worksheet</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row_num</span><span class="p">,</span> <span class="n">col_num</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">)</span>
        
        <span class="c1"># Close the workbook before sending the data.</span>
        <span class="n">workbook</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># Rewind the buffer.</span>
        <span class="n">output</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Set up the Http response.</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s1">&#39;Daftar Surat Masuk.xlsx&#39;</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span>
            <span class="n">output</span><span class="p">,</span>
            <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span>
        <span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>

        <span class="k">return</span> <span class="n">response</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Surat masuk tidak bisa dicetak&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>
        

<div class="viewcode-block" id="ubah_status_surat_masuk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.ubah_status_surat_masuk">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">ubah_status_surat_masuk</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>       
    <span class="sd">&quot;&quot;&quot; Function untuk mengubah status surat masuk (diterima, proses, selesai)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>
            
    <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/ubah_status/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>    

    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>        
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat masuk tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>            
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<span class="c1"># ================================================ Disposisi ==========================================================================================</span>
<div class="viewcode-block" id="BuatDisposisi"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatDisposisi">[docs]</a><span class="k">class</span> <span class="nc">BuatDisposisi</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class View untuk membuat disposisi</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="BuatDisposisi.post"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatDisposisi.post">[docs]</a>    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">update_kotak_masuk</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function View untuk membuat disposisi</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">),</span>
            <span class="s2">&quot;dari&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uniid_penerima&#39;</span><span class="p">)),</span>            
            <span class="c1"># &quot;kepada&quot;: (None,x),</span>
            <span class="s2">&quot;isi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pesan&#39;</span><span class="p">)),</span>
        <span class="p">}</span>        

        <span class="k">if</span> <span class="s1">&#39;tujuan_desposisi&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_desposisi&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan</span> <span class="o">+=</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;daftar_tujuan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;file_disposisi&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;file_disposisi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file_disposisi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file_disposisi&#39;</span><span class="p">])</span>

        <span class="n">disposisi_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/disposisi/&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">disposisi_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span><span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>            
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>            
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratmasuktahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat masuk tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;detailsuratmasuk&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span></div></div>
        

<span class="c1"># disposisi yang ditujukan kepadanya</span>
<div class="viewcode-block" id="DisposisiMasuk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DisposisiMasuk">[docs]</a><span class="k">class</span> <span class="nc">DisposisiMasuk</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>    
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
    
<div class="viewcode-block" id="DisposisiMasuk.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DisposisiMasuk.get">[docs]</a>    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">update_kotak_masuk</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>        
        <span class="sd">&quot;&quot;&quot; Function Class View untuk melihat daftar disposisi masuk</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span><span class="p">,</span>
        <span class="p">}</span>                

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/disposisi_masuk&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/disposisimasuk.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disposisi&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;disposisi_masuk&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">})</span></div></div>


<span class="c1"># disposisi yang dikeluarkan olehnya</span>
<div class="viewcode-block" id="DisposisiKeluar"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DisposisiKeluar">[docs]</a><span class="k">class</span> <span class="nc">DisposisiKeluar</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
    
<div class="viewcode-block" id="DisposisiKeluar.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DisposisiKeluar.get">[docs]</a>    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">update_kotak_masuk</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function Class View untuk melihat daftar disposisi keluar</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span><span class="p">,</span>
        <span class="p">}</span>         

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/disposisi_keluar&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/disposisikeluar.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disposisi&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;disposisi_keluar&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="DisposisiMasukDetail"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DisposisiMasukDetail">[docs]</a><span class="k">class</span> <span class="nc">DisposisiMasukDetail</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
    
<div class="viewcode-block" id="DisposisiMasukDetail.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DisposisiMasukDetail.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function Class View untuk melihat detail disposisi masuk</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">),</span>
        <span class="p">}</span>                

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratmasuk/disposisi_detail/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>            
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span>    
            <span class="n">isi_pesan</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;isi_pesan&#39;</span><span class="p">]</span>    
            <span class="n">kepada</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;kepada&#39;</span><span class="p">]</span>    
            <span class="n">url_file_disposisi</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;url_file_disposisi&#39;</span><span class="p">]</span>    
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/detaildisposisi.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disposisi&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;url_backend&#39;</span><span class="p">:</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="p">,</span><span class="s1">&#39;disposisi_masuk&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">,</span><span class="s1">&#39;pesan&#39;</span><span class="p">:</span><span class="n">isi_pesan</span><span class="p">,</span> <span class="s1">&#39;kepada&#39;</span><span class="p">:</span><span class="n">kepada</span> <span class="p">,</span><span class="s1">&#39;url_file_disposisi&#39;</span><span class="p">:</span><span class="n">url_file_disposisi</span><span class="p">})</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat masuk tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;detailsuratmasuk&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>        </div></div>


<span class="c1"># ================================================ Surat Keluar ==========================================================================================</span>
<div class="viewcode-block" id="SuratKeluar"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratKeluar">[docs]</a><span class="k">class</span> <span class="nc">SuratKeluar</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="SuratKeluar.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratKeluar.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        

        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>

        <span class="c1"># cari surat keluar sesuai jabatan dia di session</span>
        <span class="n">suratkeluar_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suratkeluar_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span><span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">konteks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>
        
        <span class="c1"># dapatkan hasil surat keluar</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonresponse</span>
        <span class="c1"># eerror handling</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keluar tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/suratkeluar.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratkeluar&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="SuratKeluarTahun"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratKeluarTahun">[docs]</a><span class="k">class</span> <span class="nc">SuratKeluarTahun</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
        
<div class="viewcode-block" id="SuratKeluarTahun.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratKeluarTahun.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">tahun</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>        
        <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        

        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>
        
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>
    
        <span class="c1"># dapatkan tahun untuk di list</span>
        <span class="n">struktural_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/list_tahun&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">struktural_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>        

        <span class="c1"># dapatkan surat keluar</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tahun</span>
        <span class="n">suratkeluar_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/tahun/</span><span class="si">{</span><span class="n">tahun</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suratkeluar_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>            
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonresponse</span>                        
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/suratkeluartahun.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratkeluar&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keluar tidak dapat diakses&quot;</span>            
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>            
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;sipas_home&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DetailSuratKeluar"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DetailSuratKeluar">[docs]</a><span class="k">class</span> <span class="nc">DetailSuratKeluar</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
    
<div class="viewcode-block" id="DetailSuratKeluar.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.DetailSuratKeluar.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>        
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>                        
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>

        <span class="n">detailsuratkeluar_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">detailsuratkeluar_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">url_backend</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
            <span class="n">list_penerima</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_penerima&#39;</span><span class="p">]</span>
            <span class="n">list_disposisi</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_disposisi&#39;</span><span class="p">]</span>            

            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/detailsuratkeluar.html&#39;</span><span class="p">,</span>
                          <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratkeluar&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">,</span> <span class="s1">&#39;list_penerima&#39;</span><span class="p">:</span> <span class="n">list_penerima</span><span class="p">,</span>
                                   <span class="s1">&#39;url_backend&#39;</span><span class="p">:</span> <span class="n">url_backend</span><span class="p">,</span> <span class="s1">&#39;list_disposisi&#39;</span><span class="p">:</span> <span class="n">list_disposisi</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keluar tidak dapat diakses&quot;</span>            
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/detailsuratkeluar.html&#39;</span><span class="p">,</span><span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratkeluar&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="BuatSuratKeluar"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSuratKeluar">[docs]</a><span class="k">class</span> <span class="nc">BuatSuratKeluar</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
    <span class="n">kode_jabatan_tertinggi</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

<div class="viewcode-block" id="BuatSuratKeluar.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSuratKeluar.get">[docs]</a>    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">update_kotak_masuk</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">konteks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        
        <span class="c1"># untuk isian kode surat keluar</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_tujuan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">KODE_TUJUAN</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">KODE_URUSAN</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;bulan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BULAN</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;jenis_surat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">JENIS_SURAT</span>

        <span class="n">bulan_sekarang</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;bulan_sekarang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bulan_sekarang</span><span class="o">.</span><span class="n">month</span>

        <span class="c1"># untuk isian tujuan surat pegawai</span>
        <span class="n">list_tendik</span> <span class="o">=</span> <span class="n">get_tendik</span><span class="p">()</span>
        <span class="n">list_dosen</span> <span class="o">=</span> <span class="n">get_dosen</span><span class="p">()</span>
        <span class="n">list_pegawai</span> <span class="o">=</span> <span class="n">list_tendik</span><span class="o">+</span><span class="n">list_dosen</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_pegawai&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_pegawai</span>

        <span class="c1"># untuk isian tujuan surat jabatan</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/jabatan_list&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_jabtan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>

        <span class="c1"># untuk dilempar ke uniid penerima jika bukan admin rektorat</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_jabatan</span>
        <span class="c1"># untuk daftar yang berhak ttd  khusus rektorat               </span>
        <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>            
            <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_jabatan_unit/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_jabatan_ttd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_jabatan&#39;</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/uniid_penjabat/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;uniid_penjabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uniid_penjabat&#39;</span><span class="p">]</span>        

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/generate_nomor/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;nomor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;nomor&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/buat_surat_keluar.html&#39;</span><span class="p">,</span> <span class="n">konteks</span><span class="p">)</span></div>


<div class="viewcode-block" id="BuatSuratKeluar.post"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSuratKeluar.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>                

        <span class="c1"># cek ada tidaknya file</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
            <span class="n">file_draft</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
            <span class="n">file_draft_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_draft</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">file_draft_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># data yang akan dikirim        </span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>            
            <span class="c1"># untuk auth</span>
            <span class="s1">&#39;kode_jabatan&#39;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">),</span>            
            <span class="c1"># untuk isian di surat keluar</span>
            <span class="s1">&#39;file_draft&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">file_draft_name</span><span class="p">,</span> <span class="n">file_draft</span><span class="p">),</span>
            <span class="s1">&#39;sifat_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sifat_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;asal_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;asal_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;alamat_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alamat_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tujuan_surat_eksternal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_surat_eksternal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;kode_tujuan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_tujuan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;kode_urusan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_acara&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_acara&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;perihal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perihal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;ringkasan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;catatan_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;catatan_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;bulan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bulan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tahun&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tahun&#39;</span><span class="p">)),</span>            
            <span class="c1"># &#39;nama_file&#39;: (None, file_draft_name),</span>
            <span class="s1">&#39;no_extend&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nomor_extend&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;nomor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nomor&#39;</span><span class="p">)),</span>            
            <span class="c1"># &#39;ditandatangani_oleh&#39;: (None, request.POST.get(&#39;ditandatangani_oleh&#39;))</span>
        <span class="p">}</span>        

        <span class="c1"># jabatan penanda tangan dan uniid_penanda tangan</span>
        <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>
            <span class="n">ttd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">)</span>            
            <span class="n">ttd</span> <span class="o">=</span> <span class="n">ttd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>            
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">)</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">))</span>

        <span class="c1"># olah tujuan surat pejabat</span>
        <span class="k">if</span> <span class="s1">&#39;tujuan_pejabat&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan_pejabat</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan_pejabat</span> <span class="o">+=</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan_pejabat</span><span class="p">)</span>

        <span class="c1"># olah tujuan surat karyawan</span>
        <span class="k">if</span> <span class="s1">&#39;tujuan_staff&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan_karyawan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_staff&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan_karyawan</span> <span class="o">+=</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;tujuan_karyawan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan_karyawan</span><span class="p">)</span>

        <span class="c1"># kirim data_kirim ke surat keluar untuk disimpan</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/&quot;</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="c1"># return redirect(&#39;suratkeluar&#39;)        </span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratkeluartahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keluar tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;BuatSuratKeluar&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HapusSuratKeluar"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.HapusSuratKeluar">[docs]</a><span class="k">def</span> <span class="nf">HapusSuratKeluar</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>
    
    <span class="n">detailsuratkeluar_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">detailsuratkeluar_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="c1"># return redirect(&#39;suratkeluar&#39;)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratkeluartahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keluar tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;detailsuratkeluar&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="EditSuratKeluar"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.EditSuratKeluar">[docs]</a><span class="k">class</span> <span class="nc">EditSuratKeluar</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
    
<div class="viewcode-block" id="EditSuratKeluar.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.EditSuratKeluar.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>        
        <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>
        
        <span class="n">detailsuratkeluar_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">detailsuratkeluar_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
            <span class="n">list_penerima</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_penerima&#39;</span><span class="p">]</span>
            <span class="n">list_penerima_uniid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_penerima_uniid&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keluar tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="c1"># return redirect(&#39;suratkeluar&#39;)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratkeluartahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># untuk isian kode surat keluar</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_tujuan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">KODE_TUJUAN</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">KODE_URUSAN</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;bulan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BULAN</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;jenis_surat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">JENIS_SURAT</span>

        <span class="c1"># untuk isian tujuan surat pegawai</span>
        <span class="n">list_tendik</span> <span class="o">=</span> <span class="n">get_tendik</span><span class="p">()</span>
        <span class="n">list_dosen</span> <span class="o">=</span> <span class="n">get_dosen</span><span class="p">()</span>
        <span class="n">list_pegawai</span> <span class="o">=</span> <span class="n">list_tendik</span><span class="o">+</span><span class="n">list_dosen</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_pegawai&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_pegawai</span>

        <span class="c1"># untuk isian tujuan surat jabatan</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/jabatan_list&quot;</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">list_jabatan</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>

        <span class="c1"># untuk dilempar ke uniid penerima jika bukan admin rektorat</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_jabatan</span>        
        <span class="c1"># untuk daftar yang berhak ttd  khusus rektorat               </span>
        <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>            
            <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_jabatan_unit/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_jabatan_ttd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_jabatan&#39;</span><span class="p">]</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/uniid_penjabat/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;uniid_penjabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uniid_penjabat&#39;</span><span class="p">]</span>        

        <span class="n">karyawan_penerima</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pejabat_penerima</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">list_pegawai</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">list_penerima_uniid</span><span class="p">:</span>
                <span class="n">karyawan_penerima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">list_jabatan</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">list_penerima_uniid</span><span class="p">:</span>
                <span class="n">pejabat_penerima</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">])</span>

        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;uniid_karyawan_penerima&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">karyawan_penerima</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;uniid_jabatan_penerima&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pejabat_penerima</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/edit_surat_keluar.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratkeluar&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">,</span> <span class="s1">&#39;list_penerima&#39;</span><span class="p">:</span> <span class="n">list_penerima</span><span class="p">,</span>
                                                                    <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span></div>

<div class="viewcode-block" id="EditSuratKeluar.post"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.EditSuratKeluar.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>        
        <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>                    

        <span class="c1"># data yang akan dikirim        </span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>            
            <span class="c1"># untuk auth</span>
            <span class="s1">&#39;kode_jabatan&#39;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">),</span>            
            <span class="s1">&#39;file_send&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;file_draft&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="s1">&#39;sifat_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sifat_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;alamat_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alamat_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tujuan_surat_eksternal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_surat_eksternal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;kode_tujuan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_tujuan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;kode_urusan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_acara&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_acara&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;perihal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perihal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;ringkasan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;catatan_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;catatan_surat&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;bulan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bulan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tahun&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tahun&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;no_extend&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_extend&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;nomor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nomor&#39;</span><span class="p">)),</span>
            <span class="c1"># &#39;ditandatangani_oleh&#39;: (None, request.POST.get(&#39;ditandatangani_oleh&#39;))            </span>
        <span class="p">}</span>

        <span class="n">detailsuratkeluar_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">detailsuratkeluar_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keluar tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="c1"># return redirect(&#39;suratkeluar&#39;)            </span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratkeluartahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># jabatan penanda tangan dan uniid_penanda tangan</span>
        <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>
            <span class="n">ttd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">)</span>            
            <span class="n">ttd</span> <span class="o">=</span> <span class="n">ttd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>            
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">)</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">))</span>

        <span class="c1"># olah tujuan surat pejabat</span>
        <span class="k">if</span> <span class="s1">&#39;tujuan_pejabat&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan_pejabat</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan_pejabat</span> <span class="o">+=</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan_pejabat</span><span class="p">)</span>

        <span class="c1"># olah tujuan surat karyawan</span>
        <span class="k">if</span> <span class="s1">&#39;tujuan_staff&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan_karyawan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_staff&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan_karyawan</span> <span class="o">+=</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;tujuan_karyawan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan_karyawan</span><span class="p">)</span>

        <span class="c1"># masukin file_draft dan atau file_send ke data_kirim</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">data</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;file_draft&#39;</span><span class="p">:</span>
                <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;nama_file_draft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;file_send&#39;</span><span class="p">:</span>
                <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;nama_file_send&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># jika tombol kirim dipencet (dikirim sekarang)</span>
        <span class="k">if</span> <span class="s1">&#39;kirim_sekarang&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;is_delivered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="c1"># exception jika tujuan surat tidak ada sama sekali</span>
            <span class="nb">print</span><span class="p">(</span><span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_surat_eksternal&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_staff&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_surat_eksternal&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_staff&#39;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="s2">&quot;Kepada Pejabat, Kepada Dosen/Karyawan, atau Tujuan Surat Eksternal salah satu harus di isi&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;edit_surat_keluar&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>        

            <span class="c1"># exception jika file_fix tidak diinputkan dan belum ada    </span>
            <span class="nb">print</span><span class="p">(</span><span class="ow">not</span> <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;file_send&#39;</span><span class="p">])</span>        
            <span class="nb">print</span><span class="p">(</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="s1">&#39;file_fix_arsip_url&#39;</span><span class="p">])</span>        
            <span class="k">if</span> <span class="s2">&quot;file_send&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>                
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;masuk&quot;</span><span class="p">)</span>
                <span class="c1"># file_fix belum ada                </span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="s1">&#39;file_fix_arsip_url&#39;</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;masuk2&quot;</span><span class="p">)</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="s2">&quot;File fix harus di isi &quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;edit_surat_keluar&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>        

            <span class="c1"># if data_kirim[&#39;file_draft&#39;] and not r.json()[&#39;rows&#39;][&#39;file_fix_arsip_url&#39;] and not data_kirim[&#39;tujuan_surat_eksternal&#39;]:</span>
            <span class="c1">#     &#39;&#39;&#39;file send tidak disertakan, file send wajib di isi&#39;&#39;&#39;</span>
            <span class="c1">#     messages.add_message(request, messages.ERROR, &quot;File fix harus di isi ..&quot;)</span>
            <span class="c1">#     return render(request, &#39;surat/edit_surat_keluar.html&#39;,</span>
            <span class="c1">#                   context={&#39;suratkeluar&#39;: True, &#39;content&#39;: jsonresponse, &#39;list_penerima&#39;: list_penerima,</span>
            <span class="c1">#                            &#39;konteks&#39;: konteks})</span>

        <span class="c1"># jika tombol simpan diklik</span>
        <span class="k">elif</span> <span class="s1">&#39;simpan_draft&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;is_delivered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># ubah surat keluar</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeluar/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>      
            <span class="c1"># return redirect(&#39;suratkeluar&#39;)          </span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;suratkeluartahun&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># error handling            </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keluar tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;edit_surat_keluar&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>        </div></div>


<span class="c1"># ================================================ Delegasi ==========================================================================================</span>
<div class="viewcode-block" id="Delegasi"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.Delegasi">[docs]</a><span class="k">class</span> <span class="nc">Delegasi</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
    
<div class="viewcode-block" id="Delegasi.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.Delegasi.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/delegate/&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
            <span class="n">list_tendik</span> <span class="o">=</span> <span class="n">get_tendik</span><span class="p">()</span>
            <span class="n">list_dosen</span> <span class="o">=</span> <span class="n">get_dosen</span><span class="p">()</span>
            <span class="n">list_pegawai</span> <span class="o">=</span> <span class="n">list_tendik</span><span class="o">+</span><span class="n">list_dosen</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/delegasi.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;delegasi&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">,</span> <span class="s1">&#39;list_pegawai&#39;</span><span class="p">:</span> <span class="n">list_pegawai</span><span class="p">,</span>
                                                                   <span class="s1">&#39;nama_jabatan&#39;</span><span class="p">:</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;nama_jabatan&#39;</span><span class="p">]})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan delagasi tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                    
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/delegasi.html&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Delegasi.post"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.Delegasi.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;tambah_delegasi&quot;</span><span class="p">):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/delegate/&quot;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;tambah_delegasi&quot;</span><span class="p">):</span>
                <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;uniid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                        <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan delagasi tidak dapat diakses&quot;</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                                    
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;Delegasi&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;Delegasi&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="delete_delegasi"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.delete_delegasi">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">delete_delegasi</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/delegate/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/delete/&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>        
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;Delegasi&#39;</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan delagasi tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                                    
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;Delegasi&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="delegasi_rektorat"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.delegasi_rektorat">[docs]</a><span class="k">def</span> <span class="nf">delegasi_rektorat</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>

    <span class="n">struktural_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/delegate_rektorat/&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">struktural_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>    
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;list_pejabat_rektorat&#39;</span><span class="p">]</span>
        <span class="n">nama_jabatan</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;nama_jabatan&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="n">list_tendik</span> <span class="o">=</span> <span class="n">get_tendik</span><span class="p">()</span>
        <span class="n">list_dosen</span> <span class="o">=</span> <span class="n">get_dosen</span><span class="p">()</span>
        <span class="n">list_pegawai</span> <span class="o">=</span> <span class="n">list_tendik</span><span class="o">+</span><span class="n">list_dosen</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan delagasi tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                    
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/delegasi_rektorat.html&#39;</span><span class="p">)</span>    


    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;tambah_delegasi&quot;</span><span class="p">):</span>
            <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
            <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
            <span class="p">}</span>            
            <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/delegate_rektorat/&quot;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s2">&quot;tambah_delegasi&quot;</span><span class="p">):</span>
                <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                        <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
                    <span class="k">else</span> <span class="p">:</span>
                        <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan delagasi tidak dapat diakses&quot;</span>
                    <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                                    
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;DelegasiRektorat&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;DelegasiRektorat&#39;</span><span class="p">)</span>

    
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/delegasi_rektorat.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;delegasi&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">,</span> <span class="s1">&#39;list_pegawai&#39;</span><span class="p">:</span> <span class="n">list_pegawai</span><span class="p">,</span>
                                                                <span class="s1">&#39;nama_jabatan&#39;</span><span class="p">:</span> <span class="n">nama_jabatan</span><span class="p">})</span></div>


<div class="viewcode-block" id="delete_delegasi_rektorat"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.delete_delegasi_rektorat">[docs]</a><span class="k">def</span> <span class="nf">delete_delegasi_rektorat</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/delegate_rektorat/delete/</span><span class="si">{</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>        
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;DelegasiRektorat&#39;</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan delagasi tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                                    
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;DelegasiRektorat&#39;</span><span class="p">)</span></div>


<span class="c1"># ================================================ Surat Keputusan ==========================================================================================</span>
<div class="viewcode-block" id="SuratKeputusan"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratKeputusan">[docs]</a><span class="k">class</span> <span class="nc">SuratKeputusan</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>


<div class="viewcode-block" id="SuratKeputusan.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratKeputusan.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>

        <span class="n">suratkeputusan_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suratkeputusan_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;suratkeputusan&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">jsonresponse</span><span class="p">,</span> <span class="s1">&#39;url_backend&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="p">}</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/suratkeputusan.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keputusan tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;sipas_home&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SuratKeputusanTahun"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratKeputusanTahun">[docs]</a><span class="k">class</span> <span class="nc">SuratKeputusanTahun</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">PejabatOrDelegasiOrAdminRektoratRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
        
<div class="viewcode-block" id="SuratKeputusanTahun.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SuratKeputusanTahun.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">tahun</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>        
        <span class="c1"># dapatkan token dan kode_jabatan dari session</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
        <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        

        <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
        <span class="p">}</span>
        
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        
    
        <span class="c1"># dapatkan tahun untuk di list</span>
        <span class="n">struktural_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/list_tahun&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">struktural_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>                
        <span class="k">else</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>        

        <span class="c1"># dapatkan surat keputusan</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;tahun&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tahun</span>
        <span class="n">suratkeputusan_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/tahun/</span><span class="si">{</span><span class="n">tahun</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suratkeputusan_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">jsonresponse</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="n">requests</span><span class="o">.</span><span class="n">codes</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
            <span class="n">jsonresponse</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>            
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jsonresponse</span>                        
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/suratkeputusantahun.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratkeputusan&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">,</span> <span class="s1">&#39;url_backend&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>            
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;sipas_home&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CreateSuratKeputusan"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.CreateSuratKeputusan">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">CreateSuratKeputusan</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>

    <span class="n">jabatan</span> <span class="o">=</span> <span class="n">list_jabatan</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">list_tendik</span> <span class="o">=</span> <span class="n">get_tendik</span><span class="p">()</span>
    <span class="n">list_dosen</span> <span class="o">=</span> <span class="n">get_dosen</span><span class="p">()</span>
    <span class="n">list_pegawai</span> <span class="o">=</span> <span class="n">list_tendik</span> <span class="o">+</span> <span class="n">list_dosen</span>

    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_pegawai&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_pegawai</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_kirim_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jabatan</span>

    <span class="n">struktural_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_opsi/&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">struktural_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">]</span>

    <span class="c1"># untuk dilempar ke uniid penerima jika bukan admin rektorat</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_jabatan</span>
    <span class="c1"># untuk daftar yang berhak ttd  khusus rektorat               </span>
    <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>            
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_jabatan_unit/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_jabatan_ttd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_jabatan&#39;</span><span class="p">]</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/uniid_penjabat/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;uniid_penjabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uniid_penjabat&#39;</span><span class="p">]</span>        

    <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/generate_nomor/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;nomor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;nomor&#39;</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
            <span class="n">file_draft</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
            <span class="n">file_draft_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">file_draft</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">file_draft_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># untuk auth dan isian</span>
            <span class="s1">&#39;kode_jabatan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">),</span>
            <span class="c1"># untuk isian</span>
            <span class="s1">&#39;nomor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nomor&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;kode_urusan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tahun&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tahun&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;perihal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perihal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;ringkasan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_terbit&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_terbit&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_berlaku&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_berlaku&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;nama_file&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_draft_name</span><span class="p">),</span>
            <span class="s1">&#39;is_delivered&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;False&quot;</span><span class="p">),</span>
            <span class="s1">&#39;file_draft&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">file_draft_name</span><span class="p">,</span> <span class="n">file_draft</span><span class="p">),</span>
            <span class="c1"># &#39;ditandatangani_oleh&#39;: (None, request.POST.get(&#39;ditandatangani_oleh&#39;)),</span>
        <span class="p">}</span>

        <span class="c1"># jabatan penanda tangan dan uniid_penanda tangan</span>
        <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>
            <span class="n">ttd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">)</span>            
            <span class="n">ttd</span> <span class="o">=</span> <span class="n">ttd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>            
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">)</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">))</span>        

        <span class="k">if</span> <span class="s1">&#39;tujuan_pejabat&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan_pejabat</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan_pejabat</span> <span class="o">=</span> <span class="n">list_tujuan_pejabat</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan_pejabat</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;tujuan_staff&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan_karyawan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_staff&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan_karyawan</span> <span class="o">=</span> <span class="n">list_tujuan_karyawan</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;tujuan_karyawan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan_karyawan</span><span class="p">)</span>

        <span class="n">suratkeputusan_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/&quot;</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">suratkeputusan_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="c1"># return redirect(&#39;SuratKeputusan&#39;)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;suratkeputusantahun&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keputusan tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="c1"># return redirect(&#39;SuratKeputusan&#39;)                    </span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;suratkeputusantahun&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/buat_surat_keputusan.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;suratkeputusan&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span></div>


<div class="viewcode-block" id="detail_surat_keputusan"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.detail_surat_keputusan">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">detail_surat_keputusan</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>

    <span class="n">suratkeputusan_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suratkeputusan_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/detailsuratkeputusan.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">konteks</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keputusan tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
        <span class="c1"># return redirect(&#39;SuratKeputusan&#39;)                    </span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;suratkeputusantahun&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="hapus_sk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.hapus_sk">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">hapus_sk</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>        
    <span class="c1"># masukkan kode_jabatan ke data_kirim untuk dikirim ke api melalui data</span>
    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;kode_jabatan&quot;</span><span class="p">:</span><span class="n">kode_jabatan</span>
    <span class="p">}</span>

    <span class="n">suratkeputusan_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">suratkeputusan_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">,</span> <span class="s2">&quot;Surat berhasil dihapus&quot;</span><span class="p">)</span>
        <span class="c1"># return redirect(&#39;SuratKeputusan&#39;)        </span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;suratkeputusantahun&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keputusan tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>                
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;detail_surat_keputusan&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span></div>


<div class="viewcode-block" id="edit_sk"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.edit_sk">[docs]</a><span class="nd">@pejabat_or_delegasi_or_admin_rektorat</span>
<span class="k">def</span> <span class="nf">edit_sk</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="nb">id</span><span class="p">):</span>
    <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>        
    <span class="n">kode_jabatan</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">)</span>            

    <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;kode_jabatan&#39;</span> <span class="p">:</span> <span class="n">kode_jabatan</span>
    <span class="p">}</span>

    <span class="n">suratkeputusan_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">sk</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">suratkeputusan_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">sk</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">sk</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">sk</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">sk</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">sk</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keputusan tidak dapat diakses&quot;</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
        <span class="c1"># return redirect(&#39;SuratKeputusan&#39;)                    </span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;suratkeputusantahun&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">jabatan</span> <span class="o">=</span> <span class="n">list_jabatan</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">list_tendik</span> <span class="o">=</span> <span class="n">get_tendik</span><span class="p">()</span>
    <span class="n">list_dosen</span> <span class="o">=</span> <span class="n">get_dosen</span><span class="p">()</span>
    <span class="n">list_pegawai</span> <span class="o">=</span> <span class="n">list_tendik</span> <span class="o">+</span> <span class="n">list_dosen</span>

    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_pegawai&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_pegawai</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_kirim_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jabatan</span>

    <span class="n">struktural_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_opsi/&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">struktural_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">]</span>

    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>    

    <span class="c1"># untuk dilempar ke uniid penerima jika bukan admin rektorat</span>
    <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_jabatan</span>        
    <span class="c1"># untuk daftar yang berhak ttd  khusus rektorat               </span>
    <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>            
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/list_jabatan_unit/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;list_jabatan_ttd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;list_jabatan&#39;</span><span class="p">]</span>        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/uniid_penjabat/</span><span class="si">{</span><span class="n">kode_jabatan</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;uniid_penjabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;uniid_penjabat&#39;</span><span class="p">]</span>        



    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>

        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;kode_jabatan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">),</span>
            <span class="s1">&#39;nomor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nomor&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;kode_urusan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_urusan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tahun&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tahun&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;perihal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perihal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;ringkasan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_terbit&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_terbit&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_berlaku&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_berlaku&#39;</span><span class="p">)),</span> 
            <span class="c1"># &#39;ditandatangani_oleh&#39;: (None, request.POST.get(&#39;ditandatangani_oleh&#39;)),           </span>
        <span class="p">}</span>

        <span class="c1"># jabatan penanda tangan dan uniid_penanda tangan</span>
        <span class="k">if</span> <span class="n">kode_jabatan</span> <span class="o">==</span> <span class="s1">&#39;ADMIN_REKTORAT&#39;</span><span class="p">:</span>
            <span class="n">ttd</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">)</span>            
            <span class="n">ttd</span> <span class="o">=</span> <span class="n">ttd</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>            
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttd</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;jabatan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_jabatan</span><span class="p">)</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ditandatangani_oleh&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;tujuan_pejabat&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan_pejabat</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan_pejabat</span> <span class="o">=</span> <span class="n">list_tujuan_pejabat</span><span class="o">+</span><span class="n">data</span><span class="o">+</span><span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan_pejabat</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;tujuan_staff&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">list_tujuan_karyawan</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;tujuan_staff&#39;</span><span class="p">):</span>
                <span class="n">list_tujuan_karyawan</span> <span class="o">=</span> <span class="n">list_tujuan_karyawan</span> <span class="o">+</span> <span class="n">data</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;tujuan_karyawan&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">list_tujuan_karyawan</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="n">data</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">data</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;file_draft&#39;</span><span class="p">:</span>
                <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;nama_file_draft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">data</span> <span class="o">==</span> <span class="s1">&#39;file_send&#39;</span><span class="p">:</span>
                <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;nama_file_send&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="n">data</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># jika tombol kirim dipencet (dikirim sekarang)</span>
        <span class="k">if</span> <span class="s1">&#39;kirim_sekarang&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;is_delivered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

            <span class="c1"># exception jika tujuan surat tidak ada sama sekali</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_pejabat&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tujuan_staff&#39;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="s2">&quot;Kepada pejabat, kepada karyawan salah satu harus di isi&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;edit_surat_keputusan&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>        

            <span class="c1"># exception jika file_fix tidak diinputkan dan belum ada                </span>
            <span class="k">if</span> <span class="s2">&quot;file_send&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>                
                <span class="c1"># file_fix belum ada                </span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">sk</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="s1">&#39;file_send_arsip_url&#39;</span><span class="p">]:</span>                    
                    <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="s2">&quot;File fix harus di isi &quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;edit_surat_keputusan&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>        


        <span class="c1"># jika tombol simpan diklik</span>
        <span class="k">elif</span> <span class="s1">&#39;simpan_draft&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
            <span class="n">data_kirim</span><span class="p">[</span><span class="s1">&#39;is_delivered&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">suratkeputusan_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/suratkeputusan/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">suratkeputusan_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="c1"># return redirect(&#39;SuratKeputusan&#39;)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;suratkeputusantahun&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan surat keputusan tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/edit_surat_keputusan.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">konteks</span><span class="p">)</span></div>


<span class="c1"># ================================================ Sub Kategori Arsip ===================================================================================</span>
<div class="viewcode-block" id="SubKategoriArsip"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SubKategoriArsip">[docs]</a><span class="k">class</span> <span class="nc">SubKategoriArsip</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LembagaRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="SubKategoriArsip.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.SubKategoriArsip.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>    
        <span class="c1"># jika token tidak ada, redirect ke home sipas</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data</span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span>
        <span class="p">}</span>

        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        
                
        <span class="c1"># dapatkan sub kategori arsip lembaga tempat user berada</span>
        <span class="n">subkategori_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/sub_kategori&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subkategori_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;subkategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>                    
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/subkategoriarsip.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;subkategoriarsip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan sub kategori tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;sipas_home&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BuatSubKategoriArsip"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSubKategoriArsip">[docs]</a><span class="k">class</span> <span class="nc">BuatSubKategoriArsip</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LembagaRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>
<div class="viewcode-block" id="BuatSubKategoriArsip.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSubKategoriArsip.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>    
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
                
        <span class="c1"># [untuk create sub kategori] dapatkan kategori untuk arsip</span>
        <span class="n">kategori_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/kategori&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kategori_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>    

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/buat_subkategoriarsip.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;subkategoriarsip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>        </div>


<div class="viewcode-block" id="BuatSubKategoriArsip.post"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSubKategoriArsip.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>  
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data        </span>

        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>        
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span><span class="p">,</span>
            <span class="s1">&#39;nama&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nama&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;kategori&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kategori&#39;</span><span class="p">)),</span>        
            <span class="s1">&#39;lembaga&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_lembaga</span><span class="p">),</span>        
        <span class="p">}</span>        

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/sub_kategori&quot;</span>                
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;SubKategoriArsip&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan sub kategori tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>            
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;BuatSubKategoriArsip&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BuatSubKategoriMelaluiArsip"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSubKategoriMelaluiArsip">[docs]</a><span class="k">class</span> <span class="nc">BuatSubKategoriMelaluiArsip</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LembagaRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="BuatSubKategoriMelaluiArsip.post"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatSubKategoriMelaluiArsip.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>  
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>                
        <span class="n">kode_kategori</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_kategori&#39;</span><span class="p">)</span>

        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>        
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span><span class="p">,</span>
            <span class="s1">&#39;nama&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nama&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;kategori&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kategori&#39;</span><span class="p">)),</span>        
            <span class="s1">&#39;lembaga&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_lembaga</span><span class="p">),</span>        
        <span class="p">}</span>        

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/sub_kategori&quot;</span>                
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39; Sub Kategori Berhasil Dibuat. &lt;br/&gt; Sekarang Anda dapat membuat Arsip dengan menekan tombol Buat Arsip&#39;</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;ArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span> <span class="ow">and</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan sub kategori tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>            
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;ArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span>        </div></div>

<div class="viewcode-block" id="UpdateDeleteSubKategoriArsip"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteSubKategoriArsip">[docs]</a><span class="k">class</span> <span class="nc">UpdateDeleteSubKategoriArsip</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LembagaRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="UpdateDeleteSubKategoriArsip.dispatch"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteSubKategoriArsip.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_method&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;put&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UpdateDeleteSubKategoriArsip</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="UpdateDeleteSubKategoriArsip.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteSubKategoriArsip.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data        </span>

        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>        
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span><span class="p">,</span>            
        <span class="p">}</span>        
        
        <span class="c1"># [untuk create sub kategori] dapatkan kategori untuk arsip</span>
        <span class="n">kategori_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/kategori&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kategori_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
        
        <span class="c1"># dapatkan subkategorinya</span>
        <span class="n">subkategori_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/sub_kategori/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">subkategori_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        
        <span class="c1"># error handling</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">])</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;subkategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>                    
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/edit_subkategoriarsip.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;subkategoriarsip&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan sub kategori tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;sipas_home&#39;</span><span class="p">)</span>        </div>
                    

<div class="viewcode-block" id="UpdateDeleteSubKategoriArsip.put"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteSubKategoriArsip.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>    
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data        </span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>        
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span><span class="p">,</span>
            <span class="s1">&#39;nama&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nama&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;kategori&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kategori&#39;</span><span class="p">)),</span>        
            <span class="s1">&#39;lembaga&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_lembaga</span><span class="p">),</span>        
        <span class="p">}</span>        

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/sub_kategori/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>                
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;SubKategoriArsip&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan sub kategori tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;SubKategoriArsip&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="UpdateDeleteSubKategoriArsip.delete"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteSubKategoriArsip.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data        </span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>        
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span><span class="p">,</span>            
        <span class="p">}</span>        
                
        <span class="n">deletesubkategori_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/sub_kategori/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">deletesubkategori_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>    

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>            
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;SubKategoriArsip&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>        
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan sub kategori tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;SubKategoriArsip&#39;</span><span class="p">)</span></div></div>
        

<span class="c1"># ================================================ Arsip ==========================================================================================</span>
<div class="viewcode-block" id="ArsipByKategori"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.ArsipByKategori">[docs]</a><span class="k">class</span> <span class="nc">ArsipByKategori</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LembagaRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="ArsipByKategori.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.ArsipByKategori.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; Function Class View untuk melihat daftar disposisi masuk</span>

<span class="sd">        Alur:</span>

<span class="sd">            | 1. Sistem mengambil token dan kode lembaga dari session</span>
<span class="sd">            | 2. Sistem memanggil API SIPAS untuk mendapatkan nama kategori berdasarkan kode kategori</span>
<span class="sd">            | 3. Sistem memanggil API SIPAS untuk mendapatkan daftar arsip berdasarkan kode kategori</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;url_backend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data        </span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>        
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span><span class="p">,</span>            
        <span class="p">}</span>        

        <span class="c1"># untuk aktifin url di sidebar</span>
        <span class="n">konteks</span><span class="p">[</span><span class="n">kode_kategori</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># untuk parameter buat arsip</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_kategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_kategori</span>        

        <span class="c1"># dapatkan nama kategori berdasarkan kode kategori</span>
        <span class="n">kategori_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/kategori/kode/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">kategori_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s2">&quot;nama_kategori&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="s1">&#39;nama&#39;</span><span class="p">]</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s2">&quot;id_kategori&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

        <span class="c1"># dapatkan arsip bedasarkan kategori</span>
        <span class="n">arsip_url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/arsip_by_kategori/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arsip_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;all_arsip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>        
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/arsipbykategori.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arsipbykategori&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span></div></div>


<div class="viewcode-block" id="BuatArsipByKategori"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatArsipByKategori">[docs]</a><span class="k">class</span> <span class="nc">BuatArsipByKategori</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LembagaRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="BuatArsipByKategori.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatArsipByKategori.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot; Function Class View untuk menampilkan input pembuatan Arsip berdasarkan kategori</span>

<span class="sd">        Alur:</span>

<span class="sd">            | 1. Sistem mengambil token dan kode lembaga dari session</span>
<span class="sd">            | 2. Sistem memanggil API SIPAS untuk mendapatkan sub kategori lembaga berdasarkan kode kategori dan kode lembaga</span>
<span class="sd">            |    - Jika sub kategori kosong, pengguna diminta untuk membuat sub kategori baru. Jika sub kategori sudah ada, pegguna dapat langsung membuat arsip</span>
<span class="sd">            | 3. Sistem memanggil API SIPAS untuk generate nomor arsip berdasarkan kode kategori dan kode lembaga</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data        </span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>        
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span><span class="p">,</span>            
        <span class="p">}</span>        
        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_kategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_kategori</span>
        <span class="c1"># untuk aktifin url di sidebar</span>
        <span class="n">konteks</span><span class="p">[</span><span class="n">kode_kategori</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># isian sub kategori lembaga</span>
        <span class="n">sub_kategori_lembaga</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/kategori/sub_kategori/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">kode_lembaga</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sub_kategori_lembaga</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="n">sub_kategori</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_kategori</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># messages.add_message(request, messages.WARNING, &quot;Sub Kategori Arsip kosong. Mohon buat Sub Kategori Arsip terlebih dahulu pada menu Setting -&gt; Sub Kategori.&quot;)                    </span>
            
            <span class="n">messages</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39; &lt;br /&gt; Sub Kategori Arsip ini kosong. Mohon buat Sub Kategori Arsip ini terlebih dahulu pada menu Setting -&gt; Sub Kategori. &lt;br /&gt; Atau dapat membuat Sub Kategori dengan menekan tombol berikut: &lt;a class=&quot;btn btn-primary text-white m-2&quot; data-toggle=&quot;modal&quot; data-target=&quot;#myModal&quot;&gt;Buat Sub Kategori&lt;/a&gt; &lt;br/&gt;&#39;</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;ArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span>
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;sub_kategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_kategori</span>


        <span class="c1">#generate nomor arsip</span>
        <span class="n">no_arsip</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/generate_nomor/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">kode_lembaga</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">no_arsip</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;nomor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;nomor&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">kode_kategori</span> <span class="o">==</span> <span class="s2">&quot;sk&quot;</span> <span class="ow">or</span> <span class="n">kode_kategori</span> <span class="o">==</span> <span class="s2">&quot;arsip_umum&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/buat_arsipbykategori_sk_or_umum.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arsipbykategori&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>
        <span class="k">elif</span> <span class="n">kode_kategori</span> <span class="o">==</span> <span class="s2">&quot;mou&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/buat_arsipbykategori_mou.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arsipbykategori&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>            
        <span class="k">elif</span> <span class="n">kode_kategori</span> <span class="o">==</span> <span class="s2">&quot;akreditasi&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/buat_arsipbykategori_akreditasi.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arsipbykategori&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span></div>
    
<div class="viewcode-block" id="BuatArsipByKategori.post"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.BuatArsipByKategori.post">[docs]</a>    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function Class View untuk mengirim input pembuatan Arsip berdasarkan kategori ke API SIPAS untuk disimpan</span>

<span class="sd">        Alur:</span>

<span class="sd">            | 1. Sistem mengambil token dan kode lembaga dari session</span>
<span class="sd">            | 2. Sistem mengecek inputan user</span>
<span class="sd">            | 2. Sistem memanggil API SIPAS untuk menyimpan inputan pengguna ke database</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data        </span>

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
           <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
           <span class="n">file_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
           <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>                    
            <span class="c1"># untuk auath</span>
            <span class="s1">&#39;kode_lembaga&#39;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_lembaga</span><span class="p">),</span>            
            <span class="c1"># untuk isian</span>
            <span class="s1">&#39;jenis_surat&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s1">&#39;nomor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nomor&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;sub_kategori&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sub_kategori&#39;</span><span class="p">)),</span>
            <span class="c1"># lembaga disini sebagai penanda kepemilikan</span>
            <span class="s1">&#39;lembaga&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_lembaga</span><span class="p">),</span>            
            <span class="s1">&#39;lembaga1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lembaga1&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;no_sk1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_sk1&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;lembaga2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lembaga2&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;no_sk2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_sk2&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;perihal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perihal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;ringkasan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_terbit&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_terbit&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_berlaku&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_berlaku&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;file_asli&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span>
        <span class="p">}</span>        

        <span class="n">url</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/arsip_by_kategori/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">&quot;</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>                
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;ArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>        
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan arsip tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;BuatArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UpdateDeleteArsip"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteArsip">[docs]</a><span class="k">class</span> <span class="nc">UpdateDeleteArsip</span><span class="p">(</span><span class="n">LoginRequiredMixin</span><span class="p">,</span> <span class="n">LembagaRequiredMixin</span><span class="p">,</span> <span class="n">View</span><span class="p">):</span>
    <span class="n">login_url</span> <span class="o">=</span> <span class="s1">&#39;login&#39;</span>

<div class="viewcode-block" id="UpdateDeleteArsip.dispatch"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteArsip.dispatch">[docs]</a>    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_method&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;put&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UpdateDeleteArsip</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="UpdateDeleteArsip.get"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteArsip.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function Class View untuk menampilkan input perubahan Arsip berdasarkan kategori</span>

<span class="sd">        Alur:</span>

<span class="sd">            | 1. Sistem mengambil token dan kode lembaga dari session</span>
<span class="sd">            | 2. Sistem memanggil API SIPAS untuk mendapatkan sub kategori lembaga berdasarkan kode kategori dan kode lembaga            </span>
<span class="sd">            | 3. Sistem memanggil API SIPAS untuk mencari arsip yang ingin diubah berdasarkan kode kategori dan kode lembaga</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">konteks</span> <span class="o">=</span> <span class="p">{}</span>        

        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="c1"># masukkan kode_lembaga ke data_kirim untuk dikirim ke api melalui data        </span>
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>        
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span><span class="p">,</span>            
        <span class="p">}</span>        
        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;kode_kategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kode_kategori</span>
        <span class="c1"># untuk aktifin url di sidebar</span>
        <span class="n">konteks</span><span class="p">[</span><span class="n">kode_kategori</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># sub kategori lembaga dia berada</span>
        <span class="n">sub_kategori_lembaga</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/kategori/sub_kategori/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">kode_lembaga</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">sub_kategori_lembaga</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">})</span>        
        <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;sub_kategori&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>

        <span class="c1"># cari arsip yang mau diubah</span>
        <span class="n">arsip</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arsip</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        
        <span class="c1"># jika sukses</span>
        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">konteks</span><span class="p">[</span><span class="s1">&#39;arsip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;rows&#39;</span><span class="p">]</span>  
            <span class="c1"># lihat kategori arsip, dan cari page sesuai kategori</span>
            <span class="k">if</span> <span class="n">kode_kategori</span> <span class="o">==</span> <span class="s2">&quot;sk&quot;</span> <span class="ow">or</span> <span class="n">kode_kategori</span> <span class="o">==</span> <span class="s2">&quot;arsip_umum&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/edit_arsipbykategori_sk_or_umum.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arsipbykategori&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>
            <span class="k">elif</span> <span class="n">kode_kategori</span> <span class="o">==</span> <span class="s2">&quot;mou&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/edit_arsipbykategori_mou.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arsipbykategori&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>            
            <span class="k">elif</span> <span class="n">kode_kategori</span> <span class="o">==</span> <span class="s2">&quot;akreditasi&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;surat/edit_arsipbykategori_akreditasi.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;arsipbykategori&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;konteks&#39;</span><span class="p">:</span> <span class="n">konteks</span><span class="p">})</span>        
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Http404</span>                                      
        <span class="k">else</span><span class="p">:</span>        
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan sub kategori tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;ArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span></div>


<div class="viewcode-block" id="UpdateDeleteArsip.put"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteArsip.put">[docs]</a>    <span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>            
        <span class="sd">&quot;&quot;&quot; Function Class View untuk mengirim input perubahan Arsip berdasarkan kategori ke API SIPAS untuk disimpan</span>

<span class="sd">        Alur:</span>

<span class="sd">            | 1. Sistem mengambil token dan kode lembaga dari session</span>
<span class="sd">            | 2. Sistem mengecek inputan user</span>
<span class="sd">            | 3. Sistem memanggil API SIPAS untuk menyimpan inputan pengguna ke database</span>
<span class="sd">        &quot;&quot;&quot;</span>

        
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        

        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">:</span>
           <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
           <span class="n">file_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
           <span class="n">file</span> <span class="o">=</span> <span class="kc">None</span>
           <span class="n">file_name</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>            
            <span class="c1"># untuk auath</span>
            <span class="s1">&#39;kode_lembaga&#39;</span><span class="p">:(</span><span class="kc">None</span><span class="p">,</span> <span class="n">kode_lembaga</span><span class="p">),</span>            
            <span class="c1"># untuk isian</span>
            <span class="s1">&#39;nomor&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nomor&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;sub_kategori&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sub_kategori&#39;</span><span class="p">)),</span>        
            <span class="s1">&#39;lembaga1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lembaga1&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;no_sk1&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_sk1&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;lembaga2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lembaga2&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;no_sk2&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;no_sk2&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;perihal&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perihal&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;ringkasan&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ringkasan&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_terbit&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_terbit&#39;</span><span class="p">)),</span>
            <span class="s1">&#39;tgl_berlaku&#39;</span><span class="p">:</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tgl_berlaku&#39;</span><span class="p">)),</span>            
            <span class="s1">&#39;file_asli&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span>
        <span class="p">}</span>        

        <span class="c1"># cari arsip yang mau diubah</span>
        <span class="n">arsip</span> <span class="o">=</span> <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">arsip</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>        

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>            
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;ArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span>            
        <span class="k">else</span><span class="p">:</span>        
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan arsip tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;UpdateDeleteArsip&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="o">=</span><span class="n">kode_kategori</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span> <span class="p">)</span>            </div>
        

<div class="viewcode-block" id="UpdateDeleteArsip.delete"><a class="viewcode-back" href="../../modules/sipas/index.html#surat.views.UpdateDeleteArsip.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>   
        <span class="sd">&quot;&quot;&quot; Function Class View untuk menghapus Arsip berdasarkan kategori</span>

<span class="sd">        Alur:</span>

<span class="sd">            | 1. Sistem mengambil token dan kode lembaga dari session</span>
<span class="sd">            | 2. Sistem memanggil API SIPAS untuk menghapus arsip berdasarkan kode kategori dan id</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">)</span>                
        <span class="n">kode_lembaga</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kode_lembaga&#39;</span><span class="p">)</span>        
        <span class="n">data_kirim</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kode_lembaga&quot;</span><span class="p">:</span><span class="n">kode_lembaga</span>
        <span class="p">}</span>
                
        <span class="n">delete_arsip_url</span> <span class="o">=</span>  <span class="sa">F</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">settings</span><span class="o">.</span><span class="n">SIPAS_BACKEND_URL</span><span class="si">}</span><span class="s2">/api/v1/surat/arsip/</span><span class="si">{</span><span class="n">kode_kategori</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&quot;</span>        
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete_arsip_url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="sa">F</span><span class="s1">&#39;Token </span><span class="si">{</span><span class="n">token</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">},</span> <span class="n">data</span><span class="o">=</span><span class="n">data_kirim</span><span class="p">)</span>    

        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>            
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;ArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span>        
        <span class="k">else</span><span class="p">:</span>        
            <span class="k">if</span> <span class="s1">&#39;detail&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">():</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;detail&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="s1">&#39;success&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()</span> <span class="ow">and</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;success&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">pesan_error</span> <span class="o">=</span> <span class="s2">&quot;terjadi kesalahan dan arsip tidak dapat diakses&quot;</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">messages</span><span class="o">.</span><span class="n">ERROR</span><span class="p">,</span> <span class="n">pesan_error</span><span class="p">)</span>        
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;ArsipByKategori&#39;</span><span class="p">,</span> <span class="n">kode_kategori</span><span class="p">)</span>        </div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Hak cipta 2021, BTI UMS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>